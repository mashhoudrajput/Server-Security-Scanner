<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Server Security Scan Report</title>
  <style>
    @page {
      size: A4;
      margin: 2cm;
    }
    @page {
      @bottom-center {
        font-size: 8pt;
        color: #78716c;
        content: "Page " counter(page) " of " counter(pages) " â€” Server Security Scanner";
      }
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Liberation Sans', 'DejaVu Sans', 'Segoe UI', system-ui, sans-serif;
      font-size: 10pt;
      line-height: 1.6;
      color: #1c1917;
      margin: 0;
      padding: 0;
      background: #fafaf9;
    }
    .cover-page {
      text-align: center;
      padding: 2.5cm 0;
      page-break-after: always;
      background: linear-gradient(180deg, #fafaf9 0%, #f5f5f4 100%);
    }
    .cover-bar {
      height: 5px;
      background: linear-gradient(90deg, #a8a29e, #c9a962 50%, #e5d4a1);
      margin-bottom: 1.5cm;
      border-radius: 3px;
    }
    .cover-badge {
      display: inline-block;
      font-size: 8pt;
      font-weight: 600;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: #c9a962;
      margin-bottom: 0.8cm;
      padding: 0.2cm 0.6cm;
      border: 1px solid rgba(201, 169, 98, 0.5);
      border-radius: 100px;
    }
    .cover h1 {
      font-size: 28pt;
      font-weight: 700;
      color: #1c1917;
      margin: 0 0 0.5cm;
      letter-spacing: 0.02em;
    }
    .cover .meta {
      color: #78716c;
      font-size: 10pt;
      margin: 0.3cm 0;
      letter-spacing: 0.02em;
    }
    .scorecard {
      display: flex;
      justify-content: center;
      gap: 0.8cm;
      margin: 1.5cm 0;
      flex-wrap: wrap;
    }
    .score-badge {
      padding: 0.45cm 1cm;
      border-radius: 24px;
      font-size: 11pt;
      font-weight: 600;
      color: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    }
    .score-pass { background: linear-gradient(135deg, #059669, #047857); }
    .score-warn { background: linear-gradient(135deg, #d97706, #b45309); }
    .score-fail { background: linear-gradient(135deg, #dc2626, #b91c1c); }
    .cover-footer {
      margin-top: 2cm;
      font-size: 8pt;
      color: #a8a29e;
      letter-spacing: 0.05em;
    }
    .section { margin-bottom: 1cm; page-break-inside: avoid; }
    .section h2 {
      font-size: 14pt;
      color: #1c1917;
      border-bottom: 2px solid #c9a962;
      padding-bottom: 0.25cm;
      margin: 0 0 0.5cm;
      font-weight: 600;
      letter-spacing: 0.03em;
    }
    .section h3 { font-size: 11pt; margin: 0.4cm 0 0.2cm; color: #44403c; font-weight: 600; }
    .server-card {
      background: #ffffff;
      border: 1px solid #e7e5e4;
      border-radius: 8px;
      padding: 0.65cm;
      margin-bottom: 0.6cm;
      page-break-inside: avoid;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .server-card.reachable { border-left: 5px solid #059669; }
    .server-card.unreachable { border-left: 5px solid #dc2626; }
    .check-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.25cm 0;
      border-bottom: 1px solid #f5f5f4;
      font-size: 9pt;
    }
    .check-row:last-child { border-bottom: none; }
    .badge {
      display: inline-block;
      padding: 0.12cm 0.4cm;
      border-radius: 14px;
      font-size: 8pt;
      font-weight: 600;
      letter-spacing: 0.02em;
    }
    .badge-pass { background: #d1fae5; color: #047857; }
    .badge-warn { background: #fef3c7; color: #b45309; }
    .badge-fail { background: #fee2e2; color: #b91c1c; }
    .badge-info { background: #f5f5f4; color: #57534e; }
    .badge-n-a { background: #e7e5e4; color: #78716c; }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 9pt;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0,0,0,0.04);
    }
    thead { display: table-header-group; }
    th, td { border: 1px solid #e7e5e4; padding: 0.35cm; text-align: left; }
    th { background: linear-gradient(135deg, #44403c, #57534e); color: #fafaf9; font-weight: 600; }
    tr:nth-child(even) { background: #fafaf9; }
    .raw-pre {
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 7pt;
      white-space: pre-wrap;
      background: #fafaf9;
      padding: 0.4cm;
      border-radius: 6px;
      border: 1px solid #e7e5e4;
      max-height: 4cm;
      overflow: hidden;
    }
    .fixes-box {
      background: #fffbeb;
      border: 1px solid #c9a962;
      border-radius: 6px;
      padding: 0.4cm;
      margin-top: 0.25cm;
      font-size: 9pt;
    }
    .fixes-box strong { color: #b45309; }
    .fixes-box ul { margin: 0.2cm 0 0 0.6cm; padding: 0; }
    .packages-list {
      font-family: 'Consolas', monospace;
      font-size: 7pt;
      column-count: 2;
      column-gap: 0.6cm;
      line-height: 1.4;
    }
    .report-footer {
      margin-top: 1.5cm;
      padding-top: 0.5cm;
      border-top: 2px solid #c9a962;
      font-size: 8pt;
      color: #78716c;
      text-align: center;
      letter-spacing: 0.03em;
    }
  </style>
</head>
<body>
  <div class="cover-page">
    <div class="cover-bar"></div>
    <p class="cover-badge">Enterprise Security</p>
    <div class="cover">
      <h1>Server Security Scan Report</h1>
      <p class="meta">Generated {{ timestamp }}</p>
      <p class="meta">{{ server_count }} server(s) scanned</p>
      {% if summary %}
      <div class="scorecard">
        <span class="score-badge score-pass">Pass: {{ summary.pass }}</span>
        <span class="score-badge score-warn">Warn: {{ summary.warn }}</span>
        <span class="score-badge score-fail">Fail: {{ summary.fail }}</span>
      </div>
      {% endif %}
      {% if error %}<p style="color:#dc2626;font-weight:600;">Error: {{ error }}</p>{% endif %}
    </div>
    <p class="cover-footer">Confidential - Internal Use Only</p>
  </div>

  {% if not error %}
  <div class="section">
    <h2>Executive Summary</h2>
    <table>
      <thead>
        <tr><th>Host</th><th>User</th><th>Status</th><th>Checks</th></tr>
      </thead>
      <tbody>
      {% for name, data in servers.items() %}
      <tr>
        <td>{{ data.get('host', name) }}</td>
        <td>{{ data.get('user', 'ubuntu') }}</td>
        <td>{% if data.get('reachable') %}<span class="badge badge-pass">Reachable</span>{% else %}<span class="badge badge-fail">Unreachable</span>{% endif %}</td>
        <td>{{ data.get('checks', {})|length }} checks</td>
      </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  {% for name, data in servers.items() %}
  <div class="section server-card {% if data.get('reachable') %}reachable{% else %}unreachable{% endif %}">
    <h2>{{ data.get('host', name) }} ({{ data.get('user', 'ubuntu') }})</h2>
    {% if data.get('error') %}
    <p style="color:#dc2626;font-weight:600;">Error: {{ data.error }}</p>
    {% else %}
    {% for check_name, check_data in data.get('checks', {}).items() %}
    <div class="check-row">
      <span><strong>{{ check_name.replace('_', ' ').title() }}</strong></span>
      <span class="badge badge-{{ check_data.get('status', 'info') }}">
        {{ check_data.get('status', 'info') }}{% if check_data.get('message') %} - {{ (check_data.message|default(''))[:50] }}{% elif check_data.get('findings') %} - {{ (check_data.findings[0]|default(''))[:50] }}{% endif %}
      </span>
    </div>
    {% if check_data.get('packages') %}
    <h3>Pending Updates ({{ check_data.packages|length }} packages)</h3>
    <div class="packages-list">{{ check_data.packages|join(', ') }}</div>
    {% endif %}
    {% if check_data.get('users') %}
    <h3>Sudo Users</h3>
    <p>{{ check_data.users|join(', ') }}</p>
    {% endif %}
    {% if check_data.get('ports') %}
    <h3>Open Ports (Listening)</h3>
    {% set ports_text = (check_data.ports|default([]))|join('\n') %}
    <pre class="raw-pre">{{ ports_text[:2000] }}{% if ports_text|length > 2000 %}... (truncated){% endif %}</pre>
    {% endif %}
    {% if check_data.get('fixes') %}
    <div class="fixes-box"><strong>Recommended Fixes:</strong><ul>{% for f in check_data.fixes %}<li>{{ f }}</li>{% endfor %}</ul></div>
    {% endif %}
    {% if check_data.get('raw_preview') and not check_data.get('packages') and not check_data.get('ports') and not check_data.get('users') %}
    {% set raw_txt = check_data.raw_preview|default('') %}
    <pre class="raw-pre">{{ raw_txt[:2000] }}{% if raw_txt|length > 2000 %}... (truncated){% endif %}</pre>
    {% endif %}
    {% endfor %}
    {% if data.get('lynis') and data.lynis.get('status') != 'n/a' %}
    <h3>Lynis</h3>
    <p>Hardening Index: <strong>{{ data.lynis.get('hardening_index', 'N/A') }}</strong></p>
    {% if data.lynis.get('warnings') %}
    <p><strong>Warnings:</strong></p><ul>{% for w in data.lynis.warnings[:10] %}<li>{{ w }}</li>{% endfor %}</ul>
    {% endif %}
    {% if data.lynis.get('suggestions') %}
    <p><strong>Suggestions:</strong></p><ul>{% for s in data.lynis.suggestions[:10] %}<li>{{ s }}</li>{% endfor %}</ul>
    {% endif %}
    {% endif %}
    {% endif %}
  </div>
  {% endfor %}

  {% if network_scans %}
  <div class="section">
    <h2>Network Scans</h2>
    {% for tool, result in network_scans.items() %}
    <div class="server-card">
      <h3>{{ tool|upper }}</h3>
      <p>{{ result.get('message', result.get('status', '')) }}</p>
      {% if result.get('results') %}
        {% for r in result.results %}
          {% if r is string %}
            {% set r_str = r|default('') %}
            <p class="finding-item">{{ r_str[:200] }}{% if r_str|length > 200 %}...{% endif %}</p>
          {% else %}
            {% set r_out = r.get('output') or r.get('raw') or '' %}
            <p><strong>{{ r.get('url', r.get('host', '')) }}</strong></p>
            <pre class="raw-pre">{{ r_out[:1500] }}</pre>
          {% endif %}
        {% endfor %}
      {% endif %}
      {% if result.get('ports') %}
        {% if result.ports is mapping %}
          {% for port, ips in result.ports.items() %}<p>Port {{ port }}: {{ ips|length }} hosts</p>{% endfor %}
        {% else %}
          <p>Ports scanned: {{ result.ports }}</p>
        {% endif %}
      {% endif %}
      {% if result.get('raw_preview') and not result.get('results') %}
      {% set rp = result.raw_preview|default('') %}
      <pre class="raw-pre">{{ rp[:2000] }}</pre>
      {% endif %}
    </div>
    {% endfor %}
  </div>
  {% endif %}
  {% endif %}
  <div class="report-footer">Server Security Scanner - Report generated automatically. Do not distribute.</div>
</body>
</html>
